{% extends "VeriFact_interface/admin/base.html" %}

{% block title %}{{ user.username }} - User Details - Admin Panel{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Back button -->
    <div class="mb-6">
        <a href="{{ url_for('admin_users.user_list') }}" class="text-blue-600 hover:text-blue-800 flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Back to Users
        </a>
    </div>
    
    <!-- User Profile Header -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center">
                    <div class="h-20 w-20 rounded-full bg-white flex items-center justify-center text-3xl font-bold text-blue-600">
                        {{ user.username|first|upper }}
                    </div>
                    <div class="ml-4">
                        <h1 class="text-2xl font-bold">{{ user.username }}</h1>
                        <p class="text-blue-100">{{ user.email }}</p>
                        <div class="flex items-center mt-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full {{ 'bg-green-100 text-green-800' if user.is_active else 'bg-red-100 text-red-800' }}">
                                {{ 'Active' if user.is_active else 'Inactive' }}
                            </span>
                            <span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                {{ user.role|default('user')|title }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 md:mt-0">
                    <div class="flex space-x-2">
                        <button id="toggleStatusBtn" 
                                class="px-4 py-2 rounded-md text-sm font-medium {{ 'bg-red-100 text-red-700 hover:bg-red-200' if user.is_active else 'bg-green-100 text-green-700 hover:bg-green-200' }}"
                                data-user-id="{{ user.user_id }}"
                                data-is-active="{{ 'true' if user.is_active else 'false' }}">
                            {{ 'Deactivate User' if user.is_active else 'Activate User' }}
                        </button>
                        <button id="editUserBtn" class="px-4 py-2 bg-white text-gray-700 rounded-md text-sm font-medium border border-gray-300 hover:bg-gray-50">
                            Edit Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Details -->
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Account Information</h3>
                    <dl class="space-y-4">
                        <div class="border-b border-gray-200 pb-4">
                            <dt class="text-sm font-medium text-gray-500">Username</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ user.username }}</dd>
                        </div>
                        <div class="border-b border-gray-200 pb-4">
                            <dt class="text-sm font-medium text-gray-500">Email</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ user.email }}</dd>
                        </div>
                        <div class="border-b border-gray-200 pb-4">
                            <dt class="text-sm font-medium text-gray-500">Role</dt>
                            <dd class="mt-1">
                                <select id="roleSelect" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                        data-user-id="{{ user.user_id }}">
                                    <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                                    <option value="editor" {% if user.role == 'editor' %}selected{% endif %}>Editor</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Administrator</option>
                                </select>
                            </dd>
                        </div>
                        <div class="border-b border-gray-200 pb-4">
                            <dt class="text-sm font-medium text-gray-500">Account Status</dt>
                            <dd class="mt-1">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full {{ 'bg-green-100 text-green-800' if user.is_active else 'bg-red-100 text-red-800' }}">
                                    {{ 'Active' if user.is_active else 'Inactive' }}
                                </span>
                            </dd>
                        </div>
                    </dl>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Activity</h3>
                    <dl class="space-y-4">
                        <div class="border-b border-gray-200 pb-4">
                            <dt class="text-sm font-medium text-gray-500">Member Since</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ user.created_at.strftime('%B %d, %Y') }}</dd>
                        </div>
                        <div class="border-b border-gray-200 pb-4">
                            <dt class="text-sm font-medium text-gray-500">Last Login</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if user.last_login %}
                                    {{ user.last_login.strftime('%B %d, %Y %I:%M %p') }}
                                {% else %}
                                    Never logged in
                                {% endif %}
                            </dd>
                        </div>
                        <div class="border-b border-gray-200 pb-4">
                            <dt class="text-sm font-medium text-gray-500">Total Logins</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ user.login_count|default(0) }}</dd>
                        </div>
                        <div class="border-b border-gray-200 pb-4">
                            <dt class="text-sm font-medium text-gray-500">Reviews Submitted</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ user.review_count|default(0) }}</dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Recent Activity</h3>
        </div>
        <div class="p-6">
            {% if activity %}
                <div class="flow-root">
                    <ul class="-mb-8">
                        {% for event in activity %}
                        <li>
                            <div class="relative pb-8">
                                {% if not loop.last %}
                                <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                                {% endif %}
                                <div class="relative flex space-x-3">
                                    <div>
                                        <span class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center ring-8 ring-white">
                                            <i class="fas {{ 'fa-check text-white' if event.action_type == 'login' else 'fa-edit text-white' }}" style="font-size: 0.75rem;"></i>
                                        </span>
                                    </div>
                                    <div class="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
                                        <div>
                                            <p class="text-sm text-gray-800">
                                                {{ event.description }}
                                                <span class="font-medium text-gray-900">{{ event.details }}</span>
                                            </p>
                                        </div>
                                        <div class="whitespace-nowrap text-right text-sm text-gray-500">
                                            <time datetime="{{ event.activity_time }}">{{ event.activity_time|time_ago }}</time>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <p class="text-gray-500 text-center py-4">No recent activity found.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Toggle user status
    $('#toggleStatusBtn').on('click', function() {
        const userId = $(this).data('user-id');
        const isActive = $(this).data('is-active') === 'true';
        const $button = $(this);
        
        Swal.fire({
            title: isActive ? 'Deactivate User?' : 'Activate User?',
            text: isActive 
                ? 'This user will no longer be able to log in.' 
                : 'This user will be able to log in again.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: isActive ? '#d33' : '#3085d6',
            cancelButtonColor: '#6b7280',
            confirmButtonText: isActive ? 'Yes, deactivate' : 'Yes, activate',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/admin/api/users/${userId}/status`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ is_active: !isActive }),
                    success: function(response) {
                        if (response.success) {
                            // Update UI
                            const newStatus = !isActive;
                            $button.data('is-active', newStatus);
                            
                            // Update button text and style
                            if (newStatus) {
                                $button.removeClass('bg-green-100 text-green-700 hover:bg-green-200')
                                       .addClass('bg-red-100 text-red-700 hover:bg-red-200')
                                       .text('Deactivate User');
                                
                                // Update status badge
                                $('.status-badge')
                                    .removeClass('bg-red-100 text-red-800')
                                    .addClass('bg-green-100 text-green-800')
                                    .text('Active');
                            } else {
                                $button.removeClass('bg-red-100 text-red-700 hover:bg-red-200')
                                       .addClass('bg-green-100 text-green-700 hover:bg-green-200')
                                       .text('Activate User');
                                
                                // Update status badge
                                $('.status-badge')
                                    .removeClass('bg-green-100 text-green-800')
                                    .addClass('bg-red-100 text-red-800')
                                    .text('Inactive');
                            }
                            
                            Swal.fire(
                                'Success!',
                                `User has been ${newStatus ? 'activated' : 'deactivated'}.`,
                                'success'
                            );
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'An error occurred while updating user status.';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMsg = response.error;
                            }
                        } catch (e) {}
                        
                        Swal.fire(
                            'Error!',
                            errorMsg,
                            'error'
                        );
                    }
                });
            }
        });
    });

    // Update user role
    $('#roleSelect').on('change', function() {
        const userId = $(this).data('user-id');
        const newRole = $(this).val();
        
        Swal.fire({
            title: 'Update User Role?',
            text: `Change this user's role to ${newRole}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, update role',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/admin/api/users/${userId}/role`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ role: newRole }),
                    success: function(response) {
                        if (response.success) {
                            Swal.fire(
                                'Success!',
                                `User role has been updated to ${newRole}.`,
                                'success'
                            );
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'An error occurred while updating user role.';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMsg = response.error;
                            }
                        } catch (e) {}
                        
                        Swal.fire(
                            'Error!',
                            errorMsg,
                            'error'
                        );
                        
                        // Revert the select to its previous value
                        $('#roleSelect').val('{{ user.role }}');
                    }
                });
            } else {
                // Revert the select to its previous value if cancelled
                $(this).val('{{ user.role }}');
            }
        });
    });
});
</script>
{% endblock %}
