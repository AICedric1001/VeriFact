{% extends "VeriFact_interface/admin/base.html" %}

{% block title %}Manage Reviews - Admin Panel{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Manage Reviews</h1>
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{{ url_for('admin.dashboard') }}" class="text-blue-600 hover:text-blue-800">Dashboard</a>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                            </svg>
                            <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Reviews</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Status Filter -->
    <div class="bg-white rounded-lg shadow-md mb-6 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900 flex items-center">
                <i class="fas fa-filter mr-2"></i>
                Filter Reviews
            </h3>
        </div>
        <div class="p-6">
            <div class="flex flex-wrap gap-2">
                <a href="?status=" class="px-4 py-2 text-sm font-medium rounded-md {% if not current_status %}bg-blue-100 text-blue-700{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    All
                </a>
                <a href="?status=pending" class="px-4 py-2 text-sm font-medium rounded-md {% if current_status == 'pending' %}bg-yellow-100 text-yellow-700{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    Pending
                </a>
                <a href="?status=approved" class="px-4 py-2 text-sm font-medium rounded-md {% if current_status == 'approved' %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    Approved
                </a>
                <a href="?status=rejected" class="px-4 py-2 text-sm font-medium rounded-md {% if current_status == 'rejected' %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    Rejected
                </a>
            </div>
        </div>
    </div>

    <!-- Reviews Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900 flex items-center">
                <i class="fas fa-comments mr-2"></i>
                Reviews List
            </h3>
        </div>
        <div class="overflow-x-auto">
            {% if reviews %}
            <table class="min-w-full divide-y divide-gray-200" id="reviewsTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comment</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for review in reviews %}
                    <tr id="review-{{ review.review_id }}" class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ review.review_id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ review.user_name or 'Anonymous' }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex">
                                {% for i in range(1, 6) %}
                                <svg class="w-5 h-5 {% if i <= review.rating %}text-yellow-400{% else %}text-gray-300{% endif %}" 
                                     fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 max-w-md truncate">{{ review.comment or 'No comment' }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if review.status == 'approved' %}bg-green-100 text-green-800
                                {% elif review.status == 'rejected' %}bg-red-100 text-red-800
                                else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ review.status|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ review.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-2">
                                {% if review.status != 'approved' %}
                                <button class="btn-approve p-2 text-green-600 hover:text-green-900" 
                                        data-id="{{ review.review_id }}" 
                                        title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                                
                                {% if review.status != 'rejected' %}
                                <button class="btn-reject p-2 text-red-600 hover:text-red-900" 
                                        data-id="{{ review.review_id }}" 
                                        title="Reject">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                                
                                <button class="btn-view p-2 text-blue-600 hover:text-blue-900" 
                                        data-id="{{ review.review_id }}" 
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="p-6 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-2 text-gray-300"></i>
                <p class="text-gray-600">No reviews found</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Review Details Modal -->
<div class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="relative p-4 w-full max-w-2xl max-h-full">
        <div class="relative bg-white rounded-lg shadow">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
                <h3 class="text-xl font-semibold text-gray-900">
                    Review Details
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="reviewModal">
                    <i class="fas fa-times"></i>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <div class="p-4 md:p-5 space-y-4" id="reviewDetails">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="mt-2 text-gray-600">Loading review details...</p>
                </div>
            </div>
            <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b">
                <button data-modal-hide="reviewModal" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Initialize DataTable with better configuration
$(document).ready(function() {
    const table = $('#reviewsTable').DataTable({
        order: [[5, 'desc']], // Sort by date by default
        responsive: true,
        columnDefs: [
            { orderable: false, targets: [3, 6] }, // Disable sorting on comment and actions columns
            { className: 'px-6 py-4', targets: '_all' } // Add consistent padding
        ],
        language: {
            search: "Search reviews:",
            lengthMenu: "Show _MENU_ reviews per page",
            info: "Showing _START_ to _END_ of _TOTAL_ reviews",
            infoEmpty: "No reviews found",
            infoFiltered: "(filtered from _MAX_ total reviews)"
        },
        dom: '<"flex flex-col md:flex-row items-center justify-between"<"flex items-center"l><"flex mt-4 md:mt-0"f>>rt<"flex flex-col md:flex-row justify-between items-center"ip>',
        initComplete: function() {
            $('.dataTables_filter input').addClass('border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500');
            $('.dataTables_length select').addClass('border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500');
        }
    });

    // Handle approve button click with SweetAlert2
    $(document).on('click', '.btn-approve', function() {
        const reviewId = $(this).data('id');
        updateReviewStatus(reviewId, 'approved');
    });

    // Handle reject button click with SweetAlert2
    $(document).on('click', '.btn-reject', function() {
        const reviewId = $(this).data('id');
        Swal.fire({
            title: 'Are you sure?',
            text: "You're about to reject this review. This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, reject it!',
            cancelButtonText: 'Cancel',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                updateReviewStatus(reviewId, 'rejected');
            }
        });
    });

    // Handle view details button click with Flowbite modal
    $(document).on('click', '.btn-view', function() {
        const reviewId = $(this).data('id');
        const modal = new Modal(document.getElementById('reviewModal'));
        
        // Show loading state
        $('#reviewDetails').html(`
            <div class="text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-gray-600">Loading review details...</p>
            </div>
        `);
        
        modal.show();
        
        // Load review details via AJAX
        $.get(`/admin/api/reviews/${reviewId}`)
            .done(function(data) {
                $('#reviewDetails').html(`
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-medium text-gray-900">${data.user_name || 'Anonymous'}</h4>
                                <p class="text-sm text-gray-500">${new Date(data.created_at).toLocaleString()}</p>
                            </div>
                            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                data.status === 'approved' ? 'bg-green-100 text-green-800' :
                                data.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                'bg-yellow-100 text-yellow-800'
                            }">
                                ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}
                            </span>
                        </div>
                        
                        <div class="flex items-center mb-4">
                            ${Array(5).fill().map((_, i) => `
                                <svg class="w-6 h-6 ${i < data.rating ? 'text-yellow-400' : 'text-gray-300'}" 
                                     fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            `).join('')}
                            <span class="ml-2 text-sm text-gray-500">${data.rating}/5</span>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="text-sm font-medium text-gray-700 mb-2">Review Comment</h5>
                            <p class="text-gray-700 whitespace-pre-line">${data.comment || 'No comment provided.'}</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                            <div>
                                <h5 class="text-sm font-medium text-gray-500">Review ID</h5>
                                <p class="text-gray-900">${data.review_id}</p>
                            </div>
                            <div>
                                <h5 class="text-sm font-medium text-gray-500">User ID</h5>
                                <p class="text-gray-900">${data.user_id || 'N/A'}</p>
                            </div>
                            <div>
                                <h5 class="text-sm font-medium text-gray-500">Result ID</h5>
                                <p class="text-gray-900">${data.result_id || 'N/A'}</p>
                            </div>
                            <div>
                                <h5 class="text-sm font-medium text-gray-500">Last Updated</h5>
                                <p class="text-gray-900">${new Date(data.updated_at).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `);
            })
            .fail(function() {
                $('#reviewDetails').html(`
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700">Failed to load review details. Please try again.</p>
                            </div>
                        </div>
                    </div>
                `);
            });
    });

    // Function to update review status
    function updateReviewStatus(reviewId, status) {
        const action = status === 'approved' ? 'approve' : 'reject';
        
        // Show loading state
        Swal.fire({
            title: 'Processing...',
            text: `Please wait while we ${action} this review`, 
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Make the AJAX request
        $.ajax({
            url: `/admin/reviews/${reviewId}/status`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ status: status }),
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: `Review has been ${action}d successfully.`,
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        // Reload the page to reflect changes
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.message || `Failed to ${action} review.`
                    });
                }
            },
            error: function(xhr) {
                let errorMsg = `An error occurred while trying to ${action} the review.`;
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) {
                        errorMsg = response.message;
                    }
                } catch (e) {}
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMsg
                });
            }
        });
    }
    
    // Close modal when clicking the close button or outside the modal
    $('[data-modal-hide="reviewModal"]').on('click', function() {
        const modal = new Modal(document.getElementById('reviewModal'));
        modal.hide();
    });
});
</script>
{% endblock %}
