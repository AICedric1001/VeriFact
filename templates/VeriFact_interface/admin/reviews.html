{% extends "VeriFact_interface/admin/base.html" %}

{% block title %}Review Management - Admin Panel{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="card-title">Review Management</h1>
                <p class="card-subtitle">Moderate and manage user reviews</p>
            </div>
            <div class="d-flex gap-2">
                <button onclick="refreshReviews()" class="btn btn-secondary">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Filter -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Filter Reviews</h3>
    </div>
    <div style="display: flex; gap: 0.5rem; padding: 1.5rem;">
        <a href="?status=" class="btn {% if not current_status %}btn-primary{% else %}btn-secondary{% endif %}">
            All Reviews
        </a>
        <a href="?status=pending" class="btn {% if current_status == 'pending' %}btn-primary{% else %}btn-secondary{% endif %}">
            <i class="fas fa-clock"></i>
            Pending
        </a>
        <a href="?status=approved" class="btn {% if current_status == 'approved' %}btn-primary{% else %}btn-secondary{% endif %}">
            <i class="fas fa-check"></i>
            Approved
        </a>
        <a href="?status=rejected" class="btn {% if current_status == 'rejected' %}btn-primary{% else %}btn-secondary{% endif %}">
            <i class="fas fa-times"></i>
            Rejected
        </a>
    </div>
</div>

<!-- Reviews Table -->
<div class="table-container">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
        <div>
            <h3 style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">Reviews</h3>
            <span style="color: var(--muted); font-size: 0.875rem;">{{ reviews|length }} reviews found</span>
        </div>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>User</th>
                <th>Rating</th>
                <th>Comment</th>
                <th>Status</th>
                <th>Date</th>
                <th style="text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for review in reviews %}
            <tr id="review-{{ review.review_id }}">
                <td>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--brand-veri), var(--brand-fact)); display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-weight: 600;">
                                {{ (review.user_name or 'Anonymous')[0]|upper }}
                            </span>
                        </div>
                        <div>
                            <div style="font-weight: 500; color: var(--text);">{{ review.user_name or 'Anonymous' }}</div>
                            <div style="font-size: 0.75rem; color: var(--muted);">ID: {{ review.review_id }}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.25rem;">
                        {% for i in range(1, 6) %}
                        <i class="fas fa-star" style="color: {% if i <= review.rating %}#f59e0b{% else %}#d1d5db{% endif %}; font-size: 0.875rem;"></i>
                        {% endfor %}
                        <span style="font-size: 0.75rem; color: var(--muted); margin-left: 0.25rem;">{{ review.rating }}/5</span>
                    </div>
                </td>
                <td>
                    <div style="max-width: 300px;">
                        <p style="color: var(--text); margin: 0; line-height: 1.4;">{{ review.comment or 'No comment' }}</p>
                        {% if review.comment and review.comment|length > 100 %}
                        <span style="color: var(--muted); font-size: 0.75rem;">Click to see full comment</span>
                        {% endif %}
                    </div>
                </td>
                <td>
                    {% if review.status == 'approved' %}
                        <span class="badge badge-success">
                            <i class="fas fa-check"></i>
                            Approved
                        </span>
                    {% elif review.status == 'rejected' %}
                        <span class="badge badge-danger">
                            <i class="fas fa-times"></i>
                            Rejected
                        </span>
                    {% else %}
                        <span class="badge badge-warning">
                            <i class="fas fa-clock"></i>
                            Pending
                        </span>
                    {% endif %}
                </td>
                <td>
                    <div style="color: var(--text);">
                        {{ review.created_at.strftime('%Y-%m-%d') if review.created_at else 'N/A' }}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--muted);">
                        {{ review.created_at.strftime('%H:%M') if review.created_at else '' }}
                    </div>
                </td>
                <td style="text-align: center;">
                    <div style="display: flex; justify-content: center; gap: 0.5rem;">
                        {% if review.status != 'approved' %}
                        <button onclick="approveReview({{ review.review_id }})" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; color: #10b981;" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        {% endif %}
                        
                        {% if review.status != 'rejected' %}
                        <button onclick="rejectReview({{ review.review_id }})" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; color: #ef4444;" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                        {% endif %}
                        
                        <button onclick="viewReview({{ review.review_id }})" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 3rem;">
                    <div style="color: var(--muted);">
                        <i class="fas fa-star" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                        <p style="font-size: 1.125rem; font-weight: 500; margin-bottom: 0.5rem;">No reviews found</p>
                        <p style="font-size: 0.875rem;">Try adjusting your filter settings</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Review Details Modal -->
<div id="reviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-weight: 600;">Review Details</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);">&times;</button>
        </div>
        <div id="reviewDetails" style="padding: 1.5rem;">
            <div style="text-align: center; padding: 2rem;">
                <div style="color: var(--muted);">Loading review details...</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function approveReview(reviewId) {
    if (confirm('Are you sure you want to approve this review?')) {
        updateReviewStatus(reviewId, 'approved');
    }
}

function rejectReview(reviewId) {
    if (confirm('Are you sure you want to reject this review?')) {
        updateReviewStatus(reviewId, 'rejected');
    }
}

function viewReview(reviewId) {
    const modal = document.getElementById('reviewModal');
    const details = document.getElementById('reviewDetails');
    
    // Show modal
    modal.style.display = 'flex';
    
    // Load review details
    fetch(`/admin/api/reviews/${reviewId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                details.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0; font-weight: 600;">${data.review.user_name || 'Anonymous'}</h4>
                                <p style="margin: 0; color: var(--muted); font-size: 0.875rem;">${new Date(data.review.created_at).toLocaleString()}</p>
                            </div>
                            <span class="badge ${data.review.status === 'approved' ? 'badge-success' : data.review.status === 'rejected' ? 'badge-danger' : 'badge-warning'}">
                                ${data.review.status.charAt(0).toUpperCase() + data.review.status.slice(1)}
                            </span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${Array(5).fill().map((_, i) => 
                                `<i class="fas fa-star" style="color: ${i < data.review.rating ? '#f59e0b' : '#d1d5db'};"></i>`
                            ).join('')}
                            <span style="color: var(--muted); font-size: 0.875rem;">${data.review.rating}/5</span>
                        </div>
                        
                        <div style="background: var(--input-bg); padding: 1rem; border-radius: 6px;">
                            <h5 style="margin: 0 0 0.5rem 0; font-weight: 500;">Comment</h5>
                            <p style="margin: 0; line-height: 1.5;">${data.review.comment || 'No comment provided.'}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem;">Review ID</div>
                                <div style="font-weight: 500;">${data.review.review_id}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem;">User ID</div>
                                <div style="font-weight: 500;">${data.review.user_id || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem;">Result ID</div>
                                <div style="font-weight: 500;">${data.review.result_id || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem;">Last Updated</div>
                                <div style="font-weight: 500;">${new Date(data.review.updated_at).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                details.innerHTML = `<div style="color: #ef4444;">Failed to load review details.</div>`;
            }
        })
        .catch(error => {
            details.innerHTML = `<div style="color: #ef4444;">Error loading review details.</div>`;
        });
}

function closeModal() {
    document.getElementById('reviewModal').style.display = 'none';
}

function updateReviewStatus(reviewId, status) {
    const action = status === 'approved' ? 'approve' : 'reject';
    
    fetch(`/admin/reviews/${reviewId}/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to reflect changes
            window.location.reload();
        } else {
            alert(`Failed to ${action} review: ${data.message}`);
        }
    })
    .catch(error => {
        alert(`An error occurred while trying to ${action} the review.`);
    });
}

function refreshReviews() {
    window.location.reload();
}

// Close modal when clicking outside
document.getElementById('reviewModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
